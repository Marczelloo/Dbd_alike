#pragma once

#include <cstdint>
#include <functional>
#include <string>
#include <vector>
#include <array>

#include <glm/vec3.hpp>
#include <glm/mat4x4.hpp>
#include <glm/gtc/matrix_transform.hpp>

namespace engine::ui
{
class UiSystem;
}

namespace engine::render
{
class Renderer;
}

namespace engine::platform
{
class Input;
}

namespace engine::scene
{
class World;
}

namespace game::ui
{

struct LobbyPlayer
{
    std::uint32_t netId = 0;
    std::string name = "Player";
    std::string selectedRole = "survivor";
    std::string characterId;
    bool isReady = false;
    bool isHost = false;
    bool isConnected = false;
    glm::vec3 worldPosition{0.0F, 0.0F, 0.0F};
    float rotation = 0.0F;
};

struct LobbySceneState
{
    std::vector<LobbyPlayer> players;
    int localPlayerIndex = 0;
    bool isHost = false;
    std::string selectedMap = "main";
    std::string selectedCharacter;
    std::string selectedItem;
    std::string selectedPower;
    std::string selectedAddonA;
    std::string selectedAddonB;
    std::array<std::string, 4> selectedPerks = {"", "", "", ""};
    float countdownTimer = -1.0F;
    bool countdownActive = false;
    bool matchStarting = false;
};

class LobbyScene
{
public:
    using StartMatchCallback = std::function<void(const std::string& map, const std::string& role, const std::array<std::string, 4>& perks)>;
    using ReadyChangedCallback = std::function<void(bool ready)>;
    using RoleChangedCallback = std::function<void(const std::string& role)>;
    using CharacterChangedCallback = std::function<void(const std::string& characterId)>;
    using PerksChangedCallback = std::function<void(const std::array<std::string, 4>& perks)>;
    using ItemChangedCallback = std::function<void(const std::string& itemId, const std::string& addonA, const std::string& addonB)>;
    using PowerChangedCallback = std::function<void(const std::string& powerId, const std::string& addonA, const std::string& addonB)>;

    LobbyScene();
    ~LobbyScene();

    bool Initialize(engine::ui::UiSystem* uiSystem, engine::render::Renderer* renderer, engine::platform::Input* input);
    void Shutdown();

    void Update(float deltaSeconds);
    void Render3D();
    void RenderUI();
    void HandleInput();
    
    void EnterLobby();
    void ExitLobby();
    
    void SetPlayers(const std::vector<LobbyPlayer>& players);
    void SetLocalPlayerReady(bool ready);
    void SetLocalPlayerRole(const std::string& role);
    void SetLocalPlayerPerks(const std::array<std::string, 4>& perks);
    void SetCountdown(float seconds);
    void CancelCountdown();
    
    void SetStartMatchCallback(StartMatchCallback callback) { m_onStartMatch = std::move(callback); }
    void SetReadyChangedCallback(ReadyChangedCallback callback) { m_onReadyChanged = std::move(callback); }
    void SetRoleChangedCallback(RoleChangedCallback callback) { m_onRoleChanged = std::move(callback); }
    void SetCharacterChangedCallback(CharacterChangedCallback callback) { m_onCharacterChanged = std::move(callback); }
    void SetPerksChangedCallback(PerksChangedCallback callback) { m_onPerksChanged = std::move(callback); }
    void SetItemChangedCallback(ItemChangedCallback callback) { m_onItemChanged = std::move(callback); }
    void SetPowerChangedCallback(PowerChangedCallback callback) { m_onPowerChanged = std::move(callback); }
    
    void SetAvailablePerks(const std::vector<std::string>& perkIds, const std::vector<std::string>& perkNames) {
        m_availablePerkIds = perkIds;
        m_availablePerkNames = perkNames;
    }
    
    void SetAvailableCharacters(const std::vector<std::string>& survivorIds, const std::vector<std::string>& survivorNames,
                                 const std::vector<std::string>& killerIds, const std::vector<std::string>& killerNames) {
        m_survivorIds = survivorIds;
        m_survivorNames = survivorNames;
        m_killerIds = killerIds;
        m_killerNames = killerNames;
    }
    
    void SetAvailableItems(const std::vector<std::string>& itemIds, const std::vector<std::string>& itemNames) {
        m_itemIds = itemIds;
        m_itemNames = itemNames;
    }
    
    void SetAvailablePowers(const std::vector<std::string>& powerIds, const std::vector<std::string>& powerNames) {
        m_powerIds = powerIds;
        m_powerNames = powerNames;
    }
    
    void SetAvailableAddons(const std::vector<std::string>& addonIds, const std::vector<std::string>& addonNames) {
        m_addonIds = addonIds;
        m_addonNames = addonNames;
    }
    
    void SetLocalPlayerCharacter(const std::string& characterId);
    void SetLocalPlayerItem(const std::string& itemId, const std::string& addonA = "", const std::string& addonB = "");
    void SetLocalPlayerPower(const std::string& powerId, const std::string& addonA = "", const std::string& addonB = "");

    [[nodiscard]] const LobbySceneState& GetState() const { return m_state; }
    [[nodiscard]] bool IsInLobby() const { return m_isInLobby; }
    
    [[nodiscard]] glm::mat4 BuildViewProjection(float aspectRatio) const;
    [[nodiscard]] glm::vec3 CameraPosition() const;

private:
    void UpdateCamera(float deltaSeconds);
    void UpdateFireParticles(float deltaSeconds);
    void UpdatePlayerPositions();
    
    void Render3DScene();
    void RenderLobbyUI();
    void RenderPlayerSlots();
    void RenderPlayerDetails(int playerIndex);
    void RenderReadyButton();
    void RenderCountdown();
    void RenderMatchSettings();
    
    void DrawFireParticle(const glm::vec3& position, float size, float alpha);
    void DrawGroundPlane();
    void DrawCampfire();
    void DrawEnvironment();
    void DrawTrees();
    void DrawRocks();
    void DrawLogs();
    void DrawPlayerModels();
    void DrawPlayerBody(const LobbyPlayer& player);
    
    void DrawUIPanel(float x, float y, float width, float height);
    void DrawPlayerSlot(float x, float y, float width, float height, int playerIndex, bool isKillerSlot);
    void DrawRoleSelector(float x, float y, bool dropdownOnly);
    void DrawPerkSlots(float x, float y, bool dropdownOnly);
    void DrawCharacterSelector(float x, float y, bool dropdownOnly);
    void DrawItemSelector(float x, float y, bool dropdownOnly);
    void DrawPowerSelector(float x, float y, bool dropdownOnly);
    void DrawAddonSelector(float x, float y, bool isAddonA, bool dropdownOnly);
    
    void CloseAllDropdownsExcept(const std::string& keepOpen);
    void HandleAddonDropdownClick(float x, float y, bool isAddonA);
    bool isMouseOver(float x, float y, float w, float h) const;

    engine::ui::UiSystem* m_ui = nullptr;
    engine::render::Renderer* m_renderer = nullptr;
    engine::platform::Input* m_input = nullptr;
    LobbySceneState m_state;
    bool m_isInLobby = false;
    
    float m_cameraAngle = 0.0F;
    float m_cameraHeight = 2.5F;
    float m_cameraDistance = 8.0F;
    float m_cameraTargetHeight = 1.0F;
    glm::vec3 m_cameraTarget{0.0F, 0.0F, 0.0F};
    mutable glm::mat4 m_viewMatrix{1.0F};
    mutable glm::mat4 m_projectionMatrix{1.0F};
    
    float m_fireTime = 0.0F;
    struct FireParticle
    {
        glm::vec3 position{0.0F, 0.0F, 0.0F};
        glm::vec3 velocity{0.0F, 0.0F, 0.0F};
        float life = 0.0F;
        float maxLife = 1.0F;
        float size = 0.1F;
    };
    std::vector<FireParticle> m_fireParticles;
    
    StartMatchCallback m_onStartMatch;
    ReadyChangedCallback m_onReadyChanged;
    RoleChangedCallback m_onRoleChanged;
    CharacterChangedCallback m_onCharacterChanged;
    PerksChangedCallback m_onPerksChanged;
    ItemChangedCallback m_onItemChanged;
    PowerChangedCallback m_onPowerChanged;
    
    std::vector<std::string> m_availablePerkIds;
    std::vector<std::string> m_availablePerkNames;
    int m_selectedPerkSlot = -1;
    
    // Character selection
    std::vector<std::string> m_survivorIds;
    std::vector<std::string> m_survivorNames;
    std::vector<std::string> m_killerIds;
    std::vector<std::string> m_killerNames;
    int m_selectedCharacterIndex = 0;
    bool m_characterDropdownOpen = false;
    
    // Item selection
    std::vector<std::string> m_itemIds;
    std::vector<std::string> m_itemNames;
    int m_selectedItemIndex = 0;
    bool m_itemDropdownOpen = false;
    
    // Power selection
    std::vector<std::string> m_powerIds;
    std::vector<std::string> m_powerNames;
    int m_selectedPowerIndex = 0;
    bool m_powerDropdownOpen = false;
    
    // Addon selection
    std::vector<std::string> m_addonIds;
    std::vector<std::string> m_addonNames;
    int m_selectedAddonAIndex = 0;
    int m_selectedAddonBIndex = 0;
    bool m_addonADropdownOpen = false;
    bool m_addonBDropdownOpen = false;
    
    static constexpr int kMaxKillers = 1;
    static constexpr int kMaxSurvivors = 4;
    static constexpr int kMaxPlayers = kMaxKillers + kMaxSurvivors;
    static constexpr float kFireRadius = 3.0F;
};

}
